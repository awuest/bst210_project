---
title: "Code"
author: 'ALA Mode (Group 2): Anja Shahu, Anna Wuest, Ligia Flores'
date: "11/4/2020"
output: pdf_document
---

```{r library_load, results = "hide", message = FALSE}
library(tidyverse)
library(RColorBrewer)
```

```{r data_load, results = "hide"}
url <- "https://meps.ahrq.gov/mepsweb/data_files/pufs/h209dat.zip"
download.file(url, temp <- tempfile())
meps_path <- unzip(temp, exdir = tempdir())
source("https://meps.ahrq.gov/mepsweb/data_stats/download_data/pufs/h209/h209ru.txt")
unlink(temp) 
```

```{r reduce_data}
# creating a reduced data frame including only the variables that we'll be considering
h209red <- data.frame("pap" = h209$ADPAP42,
                      "region" = h209$REGION18,
                      "race" = h209$RACETHX,
                      "age" = h209$AGE18X,
                      "marital_stat" = h209$MARRY18X, # newly added
                      "educ" = h209$EDUCYR, # newly added
                      "smoke_freq" = h209$OFTSMK53, # newly added
                      "income_indiv" = h209$TTLP18X,
                      "income_fam" = h209$FAMINC18,
                      "income_percpov" = h209$POVLEV18,
                      "hrsworked_rd1" = h209$HOUR31H,
                      "hrsworked_rd2" = h209$HOUR42H,
                      "hrsworked_rd3" = h209$HOUR53H,
                      "limitation" = h209$ACTLIM31, # newly added 
                      "menhlth_rd1" = h209$MNHLTH31, # already included
                      "menhlth_rd2" = h209$MNHLTH42, # already included
                      "menhlth_rd3" = h209$MNHLTH53, # already included
                      "genhlth_rd1" = h209$RTHLTH31,
                      "genhlth_rd2" = h209$RTHLTH42,
                      "genhlth_rd3" = h209$RTHLTH53,
                      "totexp" = h209$TOTEXP18,
                      "outofpocket_exp" = h209$TOTSLF18,
                      "afford_care" = h209$AFRDCA42,
                      "have_usc" = h209$HAVEUS42,
                      "dist_from_usc" = h209$TMTKUS42,
                      "rch_usc_byphn" = h209$PHNREG42,
                      "usc_offhrs_nw" = h209$OFFHOU42,
                      "usc_asks_abt_trts" = h209$TREATM42,
                      "usc_asks_hlp_dec" = h209$DECIDE42,
                      "usc_expln_options" = h209$EXPLOP42,
                      "usc_spk_lang" = h209$PRVSPK42,
                      "usc_gender" = h209$GENDRP42,
                      "inscov_gen_2018" = h209$INSCOV18) 

rm(h209) # remove original data set from environment

h209red <- h209red %>% 
  as_tibble() %>% 
  filter(pap != -1) %>% # filtering out the people who were not asked pap smear question
  filter(age >= 21 & age <= 65) # filtering to women ages 21-65 (note there was 1 inapplicable person that was filtered out as a result of this but I thought that was fine)
```

```{r}
## inputting NAs into hours worked variables
h209red$hrsworked_rd1[h209red$hrsworked_rd1 == -1] <- NA
h209red$hrsworked_rd2[h209red$hrsworked_rd2 == -1] <- NA
h209red$hrsworked_rd3[h209red$hrsworked_rd3 == -1] <- NA

# hours worked (rounded average)
h209red <- h209red %>% rowwise() %>%
  mutate(hrs_worked_avg = round(mean(c(hrsworked_rd1, hrsworked_rd2, hrsworked_rd3), na.rm = TRUE)))

h209red$hrs_worked_avg[is.nan(as.numeric(h209red$hrs_worked_avg))] <- NA

summary(h209red$hrs_worked_avg) # too many missing variables to use
```

```{r}
# re-calculating the mental and general health variables

# perceived mental heath adding NA
h209red$menhlth_rd1[h209red$menhlth_rd1 == -8 ]<- NA
h209red$menhlth_rd1[h209red$menhlth_rd1 == -1 ]<- NA

h209red$menhlth_rd2[h209red$menhlth_rd2 == -7 ]<- NA
h209red$menhlth_rd2[h209red$menhlth_rd2 == -8 ]<- NA

h209red$menhlth_rd3[h209red$menhlth_rd3 == -7 ]<- NA
h209red$menhlth_rd3[h209red$menhlth_rd3 == -8 ]<- NA
h209red$menhlth_rd3[h209red$menhlth_rd3 == -1 ]<- NA

# perceived mental health, rounded average for each group
h209red <- h209red %>% rowwise() %>%
  mutate(menhlth_avg = round(mean(c(menhlth_rd1, menhlth_rd2, menhlth_rd3), na.rm=TRUE)))

summary(h209red$menhlth_avg)

# perceived mental health converted to factor
h209red <- h209red %>% 
  mutate(menhlth_avg_f = factor(menhlth_avg, 
                                levels = c("5", "4", "3", "2", "1"))) %>%
  mutate(menhlth_avg_f = fct_recode(menhlth_avg_f,
                                    "poor" = "5",
                                    "fair" = "4",
                                    "good" = "3",
                                    "very good" = "2",
                                    "excellent" = "1"))


# re-calculating the general health variables

# perceived general heath NA
h209red$genhlth_rd1[h209red$genhlth_rd1 == -8 ] <- NA
h209red$genhlth_rd1[h209red$genhlth_rd1 == -1 ] <- NA

h209red$genhlth_rd2[h209red$genhlth_rd2 == -8 ] <- NA

h209red$genhlth_rd3[h209red$genhlth_rd3 == -7 ] <- NA
h209red$genhlth_rd3[h209red$genhlth_rd3 == -8 ] <- NA
h209red$genhlth_rd3[h209red$genhlth_rd3 == -1 ] <- NA

# perceived mental health, rounded average of each group
h209red <- h209red %>% rowwise() %>%
  mutate(genhlth_avg = round(mean(c(genhlth_rd1, genhlth_rd2, genhlth_rd3), na.rm=TRUE)))

summary(h209red$genhlth_avg)

# perceived general health converted to factor
h209red <- h209red %>% 
  mutate(genhlth_avg_f = factor(genhlth_avg, 
                                levels = c("5", "4", "3", "2", "1"))) %>%
  mutate(genhlth_avg_f = fct_recode(genhlth_avg_f,
                                   "poor" = "5",
                                   "fair" = "4",
                                   "good" = "3",
                                   "very good" = "2",
                                   "excellent" = "1"))


```

```{r}
# creating factor versions of other categorical variables 

# pap status
h209red <- h209red %>% 
  mutate(pap_f = factor(pap, 
                        levels = c("1", "2", "-15"))) %>%
  mutate(pap_f = fct_recode(pap_f, 
                            "yes" = "1",
                            "no" = "2",
                            NULL = "-15"))

# region
h209red <- h209red %>% 
  mutate(region_f = factor(region, 
                           levels = c("1", "2", "3", "4"))) %>%
  mutate(region_f = fct_recode(region_f, 
                               "northeast" = "1",
                               "midwest" = "2",
                               "south" = "3",
                               "west" = "4"))

# race
h209red <- h209red %>% 
  mutate(race_f = factor(race, 
                         levels = c("2", "1", "3", "4", "5"))) %>%
  mutate(race_f = fct_recode(race_f, 
                             "white" = "2",
                             "hispanic" = "1",
                             "black" = "3",
                             "asian" = "4",
                             "other or multiple races" = "5"))

# marital status
h209red <- h209red %>% 
  mutate(marital_stat_f = factor(marital_stat, 
                                 levels = c("5", "1", "2", "3", "4"))) %>%
  mutate(marital_stat_f = fct_recode(marital_stat_f,
                                     "never married" = "5",
                                     "married" = "1",
                                     "widowed" = "2",
                                     "divorced" = "3",
                                     "seperated" = "4"))
# education
h209red <- h209red %>%
  mutate(educ_f = factor(educ)) %>%
  mutate(educ_f = fct_collapse(educ_f,
                               "none or any elementary" = c("0", "1", "2", "3", "4", "5", "6", "7", "8"),
                               "any high school" = c("9", "10", "11", "12"),
                               "any college" = c("13", "14", "15", "16", "17"),
                               NULL = "-15",
                               NULL = c("-8", "-7"))) 
  
# smoking frequency
h209red <- h209red %>% 
  mutate(smoke_freq_f = factor(smoke_freq,
                               levels = c("3", "2", "1", "-8", "-7", "-1"))) %>%
  mutate(smoke_freq_f = fct_recode(smoke_freq_f, 
                                   "never" = "3", 
                                   "some days" = "2", 
                                   "every day" = "1", 
                                   NULL = "-8", 
                                   NULL = "-7", 
                                   NULL = "-1"))

# limitation
h209red <- h209red %>% 
  mutate(limitation_f = factor(limitation,
                               levels = c("2", "1", "-8", "-7", "-1"))) %>%
  mutate(limitation_f = fct_recode(limitation_f,
                                   "no" = "2", 
                                   "yes" = "1",
                                   NULL = "-8",
                                   NULL = "-7",
                                   NULL = "-1"))


# ability to afford care
h209red <- h209red %>% 
  mutate(afford_care_f = factor(afford_care, 
                                levels = c("2", "1", "-8", "-7"))) %>%
  mutate(afford_care_f = fct_recode(afford_care_f,
                                    "no" = "2",
                                    "yes" = "1",
                                    NULL = "-8",
                                    NULL = "-7"))

# usual source of care status
h209red <- h209red %>% 
  mutate(have_usc_f = factor(have_usc, 
                             levels = c("2", "1", "-8", "-7"))) %>%
  mutate(have_usc_f = fct_recode(have_usc_f,
                                 "no" = "2",
                                 "yes" = "1",
                                 NULL = "-8",
                                 NULL = "-7"))

# distance from provider
h209red <- h209red %>% 
  mutate(dist_from_usc = ifelse(have_usc_f == "no", 
                                -100, 
                                dist_from_usc)) %>% # creating level for not having a provider
  mutate(dist_from_usc_f = factor(dist_from_usc, 
                                  levels = c("1", "2", "3", "4", "5", "6", "-100", "-8", "-7", "-1"))) %>%
  mutate(dist_from_usc_f = fct_recode(dist_from_usc_f,
                                      "<15" = "1",
                                      "15 to 30" = "2",
                                      "31 to 60" = "3",
                                      "61 to 90" = "4",
                                      "91 to 120" = "5",
                                      ">120" = "6",
                                      "no usc" = "-100",
                                      NULL = "-8",
                                      NULL = "-7",
                                      NULL = "-1"))

# ability to reach provider by phone
h209red <- h209red %>% 
  mutate(rch_usc_byphn = ifelse(have_usc_f == "no", 
                                -100, 
                                rch_usc_byphn)) %>% # creating level for not having a provider
  mutate(rch_usc_byphn_f = factor(rch_usc_byphn, 
                                  levels = c("4", "3", "2", "1", "-100", "-8", "-7", "-1"))) %>%
  mutate(rch_usc_byphn_f = fct_recode(rch_usc_byphn_f,
                                      "not at all difficult" = "4",
                                      "not too difficult" = "3",
                                      "somewhat difficult" = "2",
                                      "very difficult" = "1",
                                      "no usc" = "-100",
                                      NULL = "-8",
                                      NULL = "-7",
                                      NULL = "-1"))

# provider offers office hours during nights/weekends
h209red <- h209red %>% 
  mutate(usc_offhrs_nw = ifelse(have_usc_f == "no", 
                                -100, 
                                usc_offhrs_nw)) %>% # creating level for not having a provider
  mutate(usc_offhrs_nw_f = factor(usc_offhrs_nw, 
                                  levels = c("-100", "2", "1", "-8", "-7", "-1"))) %>%
  mutate(usc_offhrs_nw_f = fct_recode(usc_offhrs_nw_f,
                                      "no usc" = "-100",
                                      "no" = "2",
                                      "yes" = "1",
                                      NULL = "-8",
                                      NULL = "-7",
                                      NULL = "-1"))
# provider asks about treatments
h209red <- h209red %>% 
  mutate(usc_asks_abt_trts = ifelse(have_usc_f == "no", 
                                   -100, 
                                   usc_asks_abt_trts)) %>% # creating level for not having a provider
  mutate(usc_asks_abt_trts_f = factor(usc_asks_abt_trts, 
                                      levels = c("-100", "2", "1", "-8", "-7", "-1"))) %>%
  mutate(usc_asks_abt_trts_f = fct_recode(usc_asks_abt_trts_f,
                                          "no usc" = "-100",
                                          "no" = "2",
                                          "yes" = "1",
                                          NULL = "-8",
                                          NULL = "-7",
                                          NULL = "-1"))

# provider asks person to help make decisions
h209red <- h209red %>% 
   mutate(usc_asks_hlp_dec = ifelse(have_usc_f == "no", 
                                    -100, 
                                    usc_asks_hlp_dec)) %>% # creating level for not having a provider
  mutate(usc_asks_hlp_dec_f = factor(usc_asks_hlp_dec, 
                                     levels = c("-100", "1", "2", "3", "4", "-8", "-7", "-1"))) %>%
  mutate(usc_asks_hlp_dec_f = fct_recode(usc_asks_hlp_dec_f,
                                         "no usc" = "-100",
                                         "never" = "1",
                                         "sometimes" = "2",
                                         "usually" = "3",
                                         "always" = "4",
                                         NULL = "-8",
                                         NULL = "-7",
                                         NULL = "-1"))

# provider presents and explains all options
h209red <- h209red %>% 
  mutate(usc_expln_options = ifelse(have_usc_f == "no", 
                                    -100, 
                                    usc_expln_options)) %>% # creating level for not having a provider
  mutate(usc_expln_options_f = factor(usc_expln_options, 
                                      levels = c("-100", "2", "1", "-8", "-7", "-1"))) %>%
  mutate(usc_expln_options_f = fct_recode(usc_expln_options_f,
                                          "no usc" = "-100",
                                          "no" = "2",
                                          "yes" = "1",
                                          NULL = "-8",
                                          NULL = "-7",
                                          NULL = "-1"))

# insurance indicator in 2018
h209red <- h209red %>% 
  mutate(inscov_gen_2018_f = factor(inscov_gen_2018, 
                                    levels = c("1", "2", "3"))) %>%
  mutate(inscov_gen_2018_f = fct_recode(inscov_gen_2018_f,
                                        "any private" = "1",
                                        "public only" = "2",
                                        "uninsured" = "3"))
```

```{r}
# creating combined provider availability variable using 1) distance 2) ability to reach by phone 3) office hours

h209red <- h209red %>% 
  mutate(dist_from_usc = ifelse(have_usc_f == "no", 0, dist_from_usc))
h209red$dist_from_usc[h209red$dist_from_usc == -8] <- NA
h209red$dist_from_usc[h209red$dist_from_usc == -7] <- NA

h209red <- h209red %>% 
  mutate(rch_usc_byphn = ifelse(have_usc_f == "no", 0, rch_usc_byphn))
h209red$rch_usc_byphn[h209red$rch_usc_byphn == -8] <- NA
h209red$rch_usc_byphn[h209red$rch_usc_byphn == -7] <- NA

h209red <- h209red %>% 
  mutate(usc_offhrs_nw = ifelse(have_usc_f == "no", 0, usc_offhrs_nw))
h209red$usc_offhrs_nw[h209red$usc_offhrs_nw == -8] <- NA
h209red$usc_offhrs_nw[h209red$usc_offhrs_nw == -7] <- NA
h209red$usc_offhrs_nw[h209red$usc_offhrs_nw == -1] <- NA

# creating binary access variables to use for making combined score

# give 0 to those w/o provider
# give 1 to people who have to travel 30+ minutes
# and give 2 to people who are within 30 min
h209red <- h209red %>% mutate(dist_from_usc_bin = ifelse(dist_from_usc %in% c(1, 2), 2,
                                                         ifelse(dist_from_usc %in% c(3, 4, 5, 6), 1,
                                                                dist_from_usc)))

# give 0 to those w/o provider
# and give 1 to people who answer somewhat difficult or very difficult 
# give 2 to people who answer not at all difficult or not too difficult
h209red <- h209red %>% mutate(rch_usc_byphn_bin = ifelse(rch_usc_byphn %in% c(1, 2), 1,
                                                         ifelse(rch_usc_byphn %in% c(3, 4, 5, 6), 2,
                                                                rch_usc_byphn)))

# give 0 to those w/o provider
# and give 1 to people whose provider does not offer office hours during night/weekend 
# give 2 to people whose provider does offer
h209red <- h209red %>% mutate(usc_offhrs_nw_bin = ifelse(usc_offhrs_nw == 1, 2,
                                                         ifelse(usc_offhrs_nw == 2, 1,
                                                                usc_offhrs_nw)))

# finally creating combined availability score from binary variables
h209red <- h209red %>% 
  mutate(usc_access_score = dist_from_usc_bin + rch_usc_byphn_bin + usc_offhrs_nw_bin)
```

```{r}
# creating combined provider satisfaction variable using 1) asking about treatments 2) asks person to help w/ decisions 3) explains all options

h209red <- h209red %>% 
  mutate(usc_asks_abt_trts = ifelse(have_usc_f == "no", 0, usc_asks_abt_trts))
h209red$usc_asks_abt_trts[h209red$usc_asks_abt_trts == -8] <- NA
h209red$usc_asks_abt_trts[h209red$usc_asks_abt_trts == -7] <- NA

h209red <- h209red %>% 
   mutate(usc_asks_hlp_dec = ifelse(have_usc_f == "no", 0, usc_asks_hlp_dec)) 
h209red$usc_asks_hlp_dec[h209red$usc_asks_hlp_dec == -8] <- NA
h209red$usc_asks_hlp_dec[h209red$usc_asks_hlp_dec == -7] <- NA

h209red <- h209red %>% 
  mutate(usc_expln_options = ifelse(have_usc_f == "no", 0, usc_expln_options))
h209red$usc_expln_options[h209red$usc_expln_options == -8] <- NA
h209red$usc_expln_options[h209red$usc_expln_options == -7] <- NA


# creating binary access variables to use for making combined score

# give 0 to those w/o provider
# give 1 to those who answered no
# and give 2 to those who answered yes
h209red <- h209red %>% mutate(usc_asks_abt_trts_bin = ifelse(usc_asks_abt_trts == 1, 2,
                                                             ifelse(usc_asks_abt_trts == 2, 1,
                                                                    usc_asks_abt_trts)))

# give 0 to those w/o provider
# and give 1 to those who answered never or sometimes
# give 2 to those who answered usually or always
h209red <- h209red %>% mutate(usc_asks_hlp_dec_bin = ifelse(usc_asks_hlp_dec %in% c(1, 2), 1,
                                                            ifelse(usc_asks_hlp_dec %in% c(3, 4), 2,
                                                                   usc_asks_hlp_dec)))

# give 0 to those w/o provider
# and give 1 to people who answer no
# give 2 to those who answered yes
h209red <- h209red %>% mutate(usc_expln_options_bin = ifelse(usc_expln_options == 1, 2,
                                                             ifelse(usc_expln_options == 2, 1,
                                                                    usc_expln_options)))

# finally creating combined satisfaction score from binary variables
h209red <- h209red %>% 
  mutate(usc_satisf_score = usc_asks_abt_trts_bin + usc_asks_hlp_dec_bin + usc_expln_options_bin)
```


```{r, include = FALSE}
# extra code for variables that have too many missing values and shouldn't be used

# provider speaks person's language 
#h209red <- h209red %>% 
  #mutate(usc_spk_lang = ifelse(have_usc_f == "no", 
                               #-100, 
                               #usc_spk_lang)) %>% 
  #mutate(usc_spk_lang_f = factor(usc_spk_lang, 
                                 #levels = c("-100", "2", "1", "-8", "-7", "-1"))) %>%
  #mutate(usc_spk_lang_f = fct_recode(usc_spk_lang_f,
                                     #"no usc" = "-100",
                                     #"no" = "2",
                                     #"yes" = "1",
                                     #NULL = "-8",
                                     #NULL = "-7",
                                     #NULL = "-1"))

# gender of provider
#h209red <- h209red %>% 
  #mutate(usc_gender = ifelse(have_usc_f == "no", 
                             #-100, 
                             #usc_gender)) %>% 
  #mutate(usc_gender_f = factor(usc_gender, 
                               #levels = c("1", "2", "-100", "-8", "-1"))) %>%
  #mutate(usc_gender_f = fct_recode(usc_gender_f,
                                   #"male" = "1",
                                   #"female" = "2",
                                   #"no usc" = "-100",
                                   #NULL = "-8",
                                   #NULL = "-1"))
```

```{r}
# creating our data set of usable variables 
df <- h209red %>% select(pap_f, age, income_indiv, income_fam, totexp, 
                         outofpocket_exp, menhlth_avg_f, genhlth_avg_f, 
                         region_f, race_f, marital_stat_f, educ_f, smoke_freq_f, 
                         limitation_f, afford_care_f, have_usc_f, usc_access_score, 
                         usc_satisf_score, inscov_gen_2018_f)
# note: didn't include the seperate access and satisfaction variables since we made the combined score variables (e.g. dist_from_usc_f, rch_usc_byphn_f, usc_offhrs_nw_f, usc_asks_abt_trts_f, usc_asks_hlp_dec_f, usc_expln_options_f)
```

## Bar plots demographics
```{r, include = FALSE}
# creating function for two (categorical) variable bar plots with percentages
create_two_var_bar <- function(x_var, fill_var, x_label, fill_label) {
  df %>% 
    ggplot(aes_string(x = x_var, fill = fill_var)) +
    geom_bar(position = "fill", width = 0.8) +
    theme(axis.text = element_text(size = 9),
          axis.title = element_text(size = 11),
          legend.title = element_text(size = 11),
          legend.text = element_text(size = 9)) +
    scale_y_continuous(labels = scales::percent) +
    scale_fill_brewer(palette = "RdPu") +
    labs(x = x_label, 
         y = "Percentage",
         fill = fill_label) +
    ggtitle(paste(x_label, "stratified by", tolower(fill_label)))  
}

# bar plot of pap smear vs. race/ethnicity
create_two_var_bar("pap_f", "race_f", "Pap smear status", "Race/ethnicity")

# bar plot of pap smear vs. region
create_two_var_bar("pap_f", "region_f", "Pap smear status", "Region")

#bar plot of pap smear vs. maritial status
create_two_var_bar("pap_f", "marital_stat_f", "Pap smear status", "Marital Status")

#bar plot of pap smear vs. education
create_two_var_bar("pap_f", "educ_f", "Pap smear status", "Education Status")

#bar plot of pap smear vs. smoking
create_two_var_bar("pap_f", "smoke_freq_f", "Pap smear status", "Smoking Status")
```

## Models
```{r}
# cost related
m1 <- glm(formula = pap_f ~ afford_care_f + inscov_gen_2018_f + income_indiv + income_fam, family = binomial(), data = df)
summary(m1)

# accessibility related
m2 <- glm(formula = pap_f ~ limitation_f + have_usc_f + usc_access_score, family = binomial(), data = df)
summary(m2)

# provider characteristics
m3 <- glm(formula = pap_f ~ usc_satisf_score, family = binomial(), data = df)
summary(m3)

# demographics
# region
m4 <- glm(formula = pap_f ~ region_f, family = binomial(), data = df)
summary(m4)

# race
m5 <- glm(formula = pap_f ~  race_f, family = binomial(), data = df)
summary(m5)

# age
m6 <- glm(formula = pap_f ~  age, family = binomial(), data = df)
summary(m6)

# marital status
m7 <- glm(formula = pap_f ~ marital_stat_f, family = binomial(), data = df)
summary(m7)

# education
m8 <- glm(formula = pap_f ~ educ_f, family = binomial(), data = df)
summary(m8)
```

## Forward and backward selection
```{r}
library(caret)
library(leaps)
library(LogisticDx)
library(ResourceSelection)
library(tidyr)
library(MASS)

cc_df <- df %>% drop_na()

# Removing variables based on subject matter knowledge and models

# Removing income_indiv because similar to income_fam, keeping income_fam because some women may not have an individual income. 

# Removed have_usc_f because we take into account having a provider with the access score 

mod_exp <- glm(pap_f ~ totexp, data=cc_df, family=binomial())
summary(mod_exp)
# Removing totexp because less significant and less telling, e.g. out of pocket directly incorporates cost for person, and indirectly accounts for insurance coverage

mod_oop <- glm(pap_f ~ outofpocket_exp, data=cc_df, family=binomial())
summary(mod_oop)

mod_ac <- glm(pap_f ~ afford_care_f, data=cc_df, family=binomial())
summary(mod_ac)

#full model
full_mod <- glm(pap_f ~ age + income_fam + outofpocket_exp + menhlth_avg_f + genhlth_avg_f + region_f + race_f + marital_stat_f + educ_f + smoke_freq_f + limitation_f + afford_care_f + usc_access_score + usc_satisf_score + inscov_gen_2018_f, family = binomial(), data = cc_df) 
summary(full_mod)

# forward model selection
mod_forw <- step(glm(pap_f ~ 1, data = cc_df, family = binomial()), ~ age + income_fam + outofpocket_exp + menhlth_avg_f + genhlth_avg_f + region_f + race_f + marital_stat_f + educ_f + smoke_freq_f + limitation_f + afford_care_f + usc_access_score + usc_satisf_score + inscov_gen_2018_f, direction = "forward")
summary(mod_forw)

# backward model selection
mod_back <- step(full_mod, direction = "backward")
summary(mod_back)

# forward and backward selection produce the same model: mod_back and mod_forw are the same model 


# These results indicate that the model we produced has poor fit 
hoslem.test(as.numeric(cc_df$pap_f) - 1, fitted(mod_back), g = 10)
gof(mod_back, g = 9)

mod_adj <- glm(pap_f ~ age + income_fam + outofpocket_exp + race_f + marital_stat_f + educ_f + inscov_gen_2018_f + usc_satisf_score + smoke_freq_f + afford_care_f + limitation_f + usc_access_score, family=binomial(), data=cc_df)


# Deleted some variables, and now a worse fit 
mod_del <- glm(pap_f ~ age + income_fam + outofpocket_exp + race_f + marital_stat_f + educ_f + inscov_gen_2018_f + usc_satisf_score + smoke_freq_f, family=binomial(), data=cc_df)
hoslem.test(as.numeric(cc_df$pap_f) - 1, fitted(mod_del), g = 10)

```
Backward: age income_f outofpocket_exp race_f marital_stat educ_f smoke_freq limitation_f afford_care_f usc_access_score usc_satis_score inscov_gen_2018
AIC: 5239.8
Forward: age income_fam outofpocket_exp race_f marital_stat_f educ_f inscov_gen_2018_f usc_satisf_score smoke_freq_f afford_care_f limitation_f usc_access_score
AIC: 5239.8


# Secondary Questions
```{r}
# Testing age-squared
mod_age <- glm(pap_f ~ age ,family=binomial(), data=cc_df)
summary(mod_age)
mod_age_sq <- glm(pap_f ~ age + I(age^2),family=binomial(), data=cc_df)
summary(mod_age_sq)

# Testing confounding of marital status and family income
mod_conf1 <- glm(pap_f ~ income_fam, data=cc_df, family=binomial())
summary(mod_conf1)
mod_conf2 <- glm(pap_f ~ income_fam + marital_stat_f, data=cc_df, family=binomial())
summary(mod_conf2)

# Appreciable difference between income beta and income beta with marital status
percent_diff <- ((-4.538e-06 + 5.891e-06)/-4.538e-06)*100
percent_diff

# Testing for effect modification between marital status and family income
mod_em <- glm(pap_f ~ income_fam + marital_stat_f + income_fam*marital_stat_f, family=binomial, data=cc_df)
summary(mod_em)

anova(mod_conf2, mod_em,test = "Chisq")

# Testing for effect modification between race and access
mod_r <- glm(pap_f ~ inscov_gen_2018_f, family=binomial(), data=cc_df)
summary(mod_r)
mod_em_ri <- glm(pap_f ~ inscov_gen_2018_f + race_f, family=binomial(), data=cc_df)
summary(mod_em_ri)
mod_em_ri1 <-glm(pap_f ~ inscov_gen_2018_f + race_f + inscov_gen_2018_f*race_f, family=binomial(), data=cc_df) 
summary(mod_em_ri1)

# Appreciable difference between race and insurance coverage (confounding)
inscov_public <- 100*((0.55166-0.61057)/0.55166)
print(inscov_public)
inscov_unins <- 100*((1.10619 -1.17976 )/1.10619)
print(inscov_unins)

# Testing for effect modification between race and insurance coverage 
anova(mod_em_ri, mod_em_ri1, test="Chisq")

# Testing for effect modification between education and smoking frequency
mod_ss<- glm(pap_f ~ smoke_freq_f, family=binomial(), data=cc_df)
summary(mod_ss)
mod_es <- glm(pap_f ~ smoke_freq_f + educ_f, family=binomial(), data=cc_df)
summary(mod_es)

# Appreciable difference between education and smoking 
app_diff_ed <- 100*((0.39963-0.54751)/0.39963)
app_diff_ed
app_diff_sd <- 100*((0.34251 - 0.45238)/0.34251)
app_diff_sd

# Testing for effect modification between education and smoking frequency
mod_es_em <- glm(pap_f ~ smoke_freq_f + educ_f + smoke_freq_f*educ_f, family=binomial(), data=cc_df)

anova(mod_es_em, mod_es, test="Chisq")
```

Age squared is significant (AIC = 5645.2)

The appreciable difference between crude model (family income) and adjusted model (family income and marital status) is 22.97%, which suggests that there is confounding between marital status and family income. 

According to the ANOVA test, there appears to be effect modification between marital status and family income. We reject the null hypothesis (P < 2.22e-10) and conclude that the simpler model is not adequate. 

According to the appreciable difference rule (>10%), there only appears to be confounding between race and insurance coverage for those who are covered and no confounding for those who are unindusred. So, overall confounding between race and insurance coverage is not strong. 

Accoring to the ANOVA test, there does not appear to be effect modification between race and insurance coverate (P=0.1045), so we fail to reject the null hypothesis. The simpler model without confounding is better. 

There appreciable difference between smoking everyday and education is 37.00% and the difference between smoking some days and education is 32.08%, which suggests that there is confounding. 

According to the ANOVA, there does not appear to be an improvement with the adjusted interaction model (P=0.5294).  So we fail to reject the null hypothesis and conclude that the simpler model is sufficient. 

```{r}
# model that incorporates the interaction and quadratic terms 
final_mod <- glm(pap_f ~ age + I(age^2) + marital_stat_f + income_fam + marital_stat_f*income_fam + race_f + inscov_gen_2018_f + educ_f + smoke_freq_f, family=binomial(), data=cc_df)

summary(final_mod)

# hoslem test
hoslem.test(as.numeric(cc_df$pap_f) - 1, fitted(final_mod), g = 10)

# goodness of fit 
gof(final_mod, g = 9)
```
Significant improvement after adjusting for age-squared and interaction terms. Next time, we will continue to look at relationships between variables, and incorporate the significant variables according to backward selection as well as various interaction and quadratic terms. We may also utilize lasso and ridge regressions. 



### Ridge and Lasso Regression

# Ridge Regression

```{r} 
# Let's load libraries
library(DAAG)
library(glmnet)


# check for missing data
summary(is.na(h209red))
# Some missing data, so we may need to remove some covariates for enough data points

# omit NA's
df <- h209red[complete.cases(h209red),]


# Set up design matrix and outcome vector
x = model.matrix(pap_f ~ ., df)[,-1]
y = df$pap_f

set.seed(2) # for reproducibility
lambda_grid <- .5 ^ (-20:20)

# Fit Ridge model: here alpha=0 whereas in LASSO alpha=1
ridge.mod = glmnet(x,y, alpha=0, family="binomial", lambda = lambda_grid)
summary(ridge.mod)
ridge.mod
plot(ridge.mod)
# Get the values which plot the MSE vs Log(lambda)
# minimum is the log(lambda) that minimizes the Ridge Sum of Squares 
# (which has the Penalty term as we discussed in class)
cv.out <- cv.glmnet(x,y, alpha=0, family = "binomial")
plot(cv.out)
cv.out$lambda.min
coef.min = coef(cv.out, s="lambda.min")
active.min = which(coef.min !=0)
active.min
dimnames(coef.min)[[1]][which(coef.min !=0)]
```
